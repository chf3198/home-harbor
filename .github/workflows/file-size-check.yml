name: File Size Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  check-file-sizes:
    name: Check File Line Limits
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check file sizes (â‰¤100 lines)
        run: |
          echo "ğŸ” Checking file sizes against 100-line limit..."
          echo ""
          
          # Define max lines (project standard)
          MAX_LINES=100
          
          # Track violations
          VIOLATIONS=0
          VIOLATION_LIST=""
          
          # Check JS/TS files (excluding node_modules, dist, coverage)
          echo "ğŸ“ Scanning JS/TS files..."
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file")
              if [ "$lines" -gt "$MAX_LINES" ]; then
                VIOLATIONS=$((VIOLATIONS + 1))
                excess=$((lines - MAX_LINES))
                VIOLATION_LIST="${VIOLATION_LIST}âš ï¸  ${file}: ${lines} lines (+${excess} over limit)\n"
              fi
            fi
          done < <(find src public lambda/src frontend/src -type f \( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" \) 2>/dev/null | grep -v node_modules | grep -v dist | grep -v coverage)
          
          # Check HTML files
          echo "ğŸ“ Scanning HTML files..."
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file")
              if [ "$lines" -gt "$MAX_LINES" ]; then
                VIOLATIONS=$((VIOLATIONS + 1))
                excess=$((lines - MAX_LINES))
                VIOLATION_LIST="${VIOLATION_LIST}âš ï¸  ${file}: ${lines} lines (+${excess} over limit)\n"
              fi
            fi
          done < <(find public frontend/src -type f -name "*.html" 2>/dev/null | grep -v node_modules)
          
          # Report results
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo "ğŸ“Š FILE SIZE REPORT: ${VIOLATIONS} file(s) exceed ${MAX_LINES}-line limit"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo -e "$VIOLATION_LIST"
            echo ""
            echo "ğŸ’¡ Tip: Refactor large files into smaller, focused modules."
            echo "   See docs/CODE_STRUCTURE_PATTERNS.md for guidance."
            echo ""
            # Warning only - does not fail the build (set exit 1 to enforce)
            echo "âš ï¸  This is a warning. Consider refactoring these files."
            exit 0
          else
            echo "âœ… FILE SIZE CHECK PASSED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "All files are within the ${MAX_LINES}-line limit."
            exit 0
          fi
